{% extends 'base.html' %}
{% load humanize %}

{% block title %}Manage Subscription Plans - Erudio{% endblock %}

{% block content %}
<div x-data="planManagement()" class="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="pb-8 border-b border-gray-200 sm:flex sm:items-center sm:justify-between">
        <div>
            <h1 class="text-3xl font-bold tracking-tight text-gray-900">Manage Subscription Plans</h1>
            <p class="mt-1 text-lg text-gray-600">Create, view, and manage your B2B pricing tiers.</p>
        </div>
        <div class="mt-4 sm:mt-0">
            <button @click="openModal()" type="button" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700">
                <i class="fas fa-plus mr-2"></i> Create New Plan
            </button>
        </div>
    </div>

    <!-- Plan List Table -->
    <div class="mt-8 bg-white rounded-xl shadow-lg overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Plan Name</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Price</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Max Members</th><th class="relative px-6 py-3"></th></tr></thead>
            <tbody id="plan-list" class="divide-y divide-gray-200">
                {% for plan in plans %}
                    {% include 'partials/plan_list_item.html' with plan=plan %}
                {% empty %}
                    <tr id="no-plans-row"><td colspan="4" class="px-6 py-12 text-center text-gray-500">No subscription plans have been created yet.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Modals -->
    {% include 'partials/plan_form_modal.html' %}
    {% include 'partials/plan_delete_modal.html' %}
    
    <!-- Success Toast Notification -->
    <div x-show="showSuccessToast" x-transition:enter="transform ease-out duration-300 transition" x-transition:enter-start="translate-y-2 opacity-0 sm:translate-y-0 sm:translate-x-2" x-transition:enter-end="translate-y-0 opacity-100 sm:translate-x-0" x-transition:leave="transition ease-in duration-100" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" x-cloak class="fixed inset-0 flex items-end justify-center px-4 py-6 pointer-events-none sm:p-6 sm:items-start sm:justify-end z-50">
        <div class="max-w-sm w-full bg-white shadow-lg rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 overflow-hidden">
            <div class="p-4">
                <div class="flex items-start">
                    <div class="flex-shrink-0"><i class="fas fa-check-circle text-green-400 h-6 w-6"></i></div>
                    <div class="ml-3 w-0 flex-1 pt-0.5"><p class="text-sm font-medium text-gray-900" x-text="successMessage"></p></div>
                    <div class="ml-4 flex-shrink-0 flex"><button @click="showSuccessToast = false" class="bg-white rounded-md inline-flex text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"><span class="sr-only">Close</span><i class="fas fa-times"></i></button></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('planManagement', () => ({
        modalOpen: false,
        deleteModalOpen: false,
        isEditing: false,
        currentPlanId: null,
        planToDelete: {},
        formErrors: {},
        showSuccessToast: false,
        successMessage: '',
        
        openModal(planId = null) {
            this.formErrors = {};
            this.currentPlanId = planId;
            this.isEditing = !!planId;
            this.$refs.planForm.reset();
            if (this.isEditing) {
                this.$refs.modalTitle.textContent = 'Edit Subscription Plan';
                fetch(`/api/plans/${planId}/`)
                    .then(res => res.json())
                    .then(data => {
                        this.$refs.formName.value = data.name;
                        this.$refs.formPrice.value = data.price;
                        this.$refs.formMaxMembers.value = data.max_members;
                        this.$refs.formDescription.value = data.description;
                        this.$refs.formFeatures.value = data.features;
                    });
            } else {
                this.$refs.modalTitle.textContent = 'Create New Plan';
            }
            this.modalOpen = true;
        },
        openDeleteModal(planId, planName) {
            this.planToDelete = { id: planId, name: planName };
            this.deleteModalOpen = true;
        },
        submitForm() {
            const formData = new FormData(this.$refs.planForm);
            const url = this.isEditing ? `/api/plans/${this.currentPlanId}/update/` : `{% url 'plan_management' %}`;
            fetch(url, { method: 'POST', headers: {'X-CSRFToken': '{{ csrf_token }}'}, body: formData })
                .then(res => {
                    if (!res.ok) { this.formErrors = { general: ['An unexpected error occurred.'] }; }
                    return res.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        if (this.isEditing) {
                            document.getElementById(`plan-row-${data.plan_id}`).outerHTML = data.html;
                            this.showToast('Plan updated successfully.');
                        } else {
                            document.getElementById('no-plans-row')?.remove();
                            document.getElementById('plan-list').insertAdjacentHTML('beforeend', data.html);
                            this.showToast('New plan created successfully.');
                        }
                        this.modalOpen = false;
                    } else {
                        this.formErrors = data.errors;
                    }
                });
        },
        submitDelete() {
            fetch(`/api/plans/${this.planToDelete.id}/delete/`, { method: 'POST', headers: {'X-CSRFToken': '{{ csrf_token }}'}})
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById(`plan-row-${this.planToDelete.id}`).remove();
                        this.showToast('Plan deleted successfully.');
                        this.deleteModalOpen = false;
                    } else {
                        alert('Error: ' + data.message);
                    }
                });
        },
        showToast(message) {
            this.successMessage = message;
            this.showSuccessToast = true;
            setTimeout(() => { this.showSuccessToast = false }, 4000);
        }
    }));
});
</script>
{% endblock %}

